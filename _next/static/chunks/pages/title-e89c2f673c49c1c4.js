(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[870],{1555:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/title",function(){return n(6508)}])},9178:function(e,t,n){"use strict";n.r(t);var s=n(5893),i=n(7294),o=n(3920);let a={path:"/socket.io",cors:{origin:"http://localhost:3000",methods:["GET","POST"]}};class c extends i.Component{async componentDidMount(){console.log("hostname: ".concat(location.hostname)),this.localStream=await navigator.mediaDevices.getUserMedia({video:!0}),this.localVideoRef.current&&(this.localVideoRef.current.srcObject=this.localStream,this.sendMessage("got user media")),window.addEventListener("beforeunload",()=>{this.sendMessage("bye")})}async componentWillUnmount(){this.peerConnection&&this.peerConnection.close(),this.localStream&&this.localStream.getTracks()[0].stop(),this.sendMessage("bye"),this.socket&&this.socket.close()}render(){let{isStarted:e,isChannelReady:t,isInitiator:n}=this.state;return(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{children:"Sample 5"}),(0,s.jsx)("p",{children:"Signaling and video Peer Connection"}),(0,s.jsxs)("p",{children:["isStarted: ",String(e),","]}),(0,s.jsxs)("p",{children:["isChannelReady: ",String(t)]}),(0,s.jsxs)("p",{children:["isInitiator: ",String(n)]}),(0,s.jsx)("video",{ref:this.localVideoRef,style:{width:"320px",maxWidth:"100%"},autoPlay:!0,playsInline:!0}),(0,s.jsx)("video",{ref:this.remoteVideoRef,style:{width:"320px",maxWidth:"100%"},autoPlay:!0,playsInline:!0})]})}constructor(e){console.log("a454"),super(e),this.onicecandidate=e=>{console.log("icecandidate event: ",e),e.candidate?this.sendMessage({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):console.log("End of candidates.")},this.ontrack=e=>{console.log("ontrack"),this.remoteVideoRef.current&&(e.streams&&e.streams[0]||(this.remoteStream=new MediaStream,this.remoteStream.addTrack(e.track),this.remoteVideoRef.current.srcObject=this.remoteStream))},this.createPeer=()=>{console.log(">>>>>> creating peer connection"),this.localStream&&(this.peerConnection=new RTCPeerConnection,this.peerConnection.addEventListener("icecandidate",this.onicecandidate),this.peerConnection.addEventListener("track",this.ontrack),this.peerConnection.addTrack(this.localStream.getVideoTracks()[0]),this.setState({isStarted:!0}))},this.initiatorStart=async()=>{let{isStarted:e,isChannelReady:t}=this.state;if(console.log(">>>>>>> initiatorStart() ",e,t),!e&&t){if(this.createPeer(),!this.peerConnection)return;console.log("Sending offer to peer");let e=await this.peerConnection.createOffer();this.setLocalAndSendMessage(e)}},this.receiverStart=async()=>{let{isStarted:e,isChannelReady:t}=this.state;console.log(">>>>>>> receiverStart() ",e,t),!e&&t&&this.createPeer()},this.sendMessage=e=>{this.socket&&(console.log("Client sending message: ",e),this.socket.emit("message",e))},this.setLocalAndSendMessage=e=>{this.peerConnection&&(this.peerConnection.setLocalDescription(e),this.sendMessage(e))},this.localVideoRef=i.createRef(),this.remoteVideoRef=i.createRef(),this.socket=(0,o.ZP)("http://localhost:8000",a),this.state={isInitiator:!1,isStarted:!1,isChannelReady:!1},console.log(this.socket),console.log("a"),console.log("Asking to join room ".concat("foo")),this.socket.emit("create or join","foo"),console.log("WDASDAd"),this.socket.on("created",(e,t)=>{console.log(e),console.log(e,t),this.setState({isInitiator:!0})}),this.socket.on("full",e=>{console.log("Room ".concat(e," is full :^("))}),this.socket.on("ipaddr",e=>{console.log("Server IP address is ".concat(e))}),this.socket.on("join",e=>{console.log("Another peer made a request to join room ".concat(e)),console.log("This peer is the initiator of room ".concat(e,"!")),this.setState({isChannelReady:!0})}),this.socket.on("joined",(e,t)=>{console.log(e,t),this.setState({isChannelReady:!0})}),this.socket.on("log",e=>{console.log(e)});let t=new EventTarget;t.addEventListener("got user media",()=>{this.initiatorStart()}),t.addEventListener("bye",()=>{console.log("Session terminated."),this.peerConnection&&this.peerConnection.close(),this.setState({isStarted:!1,isChannelReady:!1,isInitiator:!0})}),t.addEventListener("offer",async e=>{let t=e.detail;if(this.state.isInitiator||this.state.isStarted||await this.receiverStart(),!this.peerConnection)return;this.peerConnection.setRemoteDescription(new RTCSessionDescription(t)),console.log("Sending answer to peer.");let n=await this.peerConnection.createAnswer();this.setLocalAndSendMessage(n)}),t.addEventListener("answer",async e=>{let t=e.detail;this.peerConnection&&this.peerConnection.setRemoteDescription(new RTCSessionDescription(t))}),t.addEventListener("candidate",async e=>{let t=e.detail;if(!this.peerConnection||!this.state.isStarted)return;let n=new RTCIceCandidate({sdpMLineIndex:t.label,candidate:t.candidate});this.peerConnection.addIceCandidate(n)}),this.socket.on("message",async e=>{"string"==typeof e?t.dispatchEvent(new Event(e)):t.dispatchEvent(new CustomEvent(e.type,{detail:e}))})}}t.default=c},6508:function(e,t,n){"use strict";n.r(t);var s=n(5893),i=n(9655),o=n(9250),a=n(9178);let c=()=>(0,s.jsxs)(i.VK,{children:[(0,s.jsx)(i.rU,{to:"/",style:{textDecoration:"none",color:"black"},children:(0,s.jsx)("h1",{children:"React WebRTC "})}),(0,s.jsx)("span",{className:"msr_btn12",children:(0,s.jsx)(i.rU,{to:"/sample5",className:"ribbon2",children:"Start"})}),(0,s.jsx)(o.AW,{path:"/sample5",Component:a.default})]});t.default=c}},function(e){e.O(0,[920,655,774,888,179],function(){return e(e.s=1555)}),_N_E=e.O()}]);